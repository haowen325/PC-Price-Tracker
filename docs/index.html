<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‘å±¬è¡Œæƒ…äº’å‹•å„€è¡¨æ¿</title>
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background-color: #f3f4f6;
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 2rem;
        }
    </style>
</head>

<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded shadow">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">ğŸ“Š ç¶œåˆåŸç‰©æ–™è¡Œæƒ…å„€è¡¨æ¿</h1>
                <p class="text-gray-600 mt-2">è¿½è¹¤éŠ…åƒ¹ã€è²´é‡‘å±¬ã€é‹¼éµè‚¡åƒ¹åŠåŒ¯ç‡èµ°å‹¢ã€‚</p>
            </div>
            <div class="mt-4 md:mt-0 text-right">
                <span class="text-sm text-gray-500">æœ€å¾Œæ›´æ–°: <span id="lastUpdated">-</span></span>
            </div>
        </header>

        <!-- Controls -->
        <div class="bg-white p-4 rounded shadow mb-6">
            <h3 class="font-bold text-gray-700 mb-2">åœ–è¡¨é¡¯ç¤ºè¨­å®š</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Group 1: Base Metals -->
                <div>
                    <h4 class="text-sm font-bold text-gray-500 mb-2">åŸºç¤é‡‘å±¬</h4>
                    <div class="flex flex-wrap gap-3">
                        <label
                            class="inline-flex items-center space-x-2 cursor-pointer bg-orange-50 px-2 py-1 rounded border border-orange-100">
                            <input type="checkbox" class="form-checkbox text-orange-600"
                                onchange="toggleTrace(0, this.checked)" checked>
                            <span class="text-gray-700">ğŸ”¶ éŠ…åƒ¹ (Copper)</span>
                        </label>
                        <label
                            class="inline-flex items-center space-x-2 cursor-pointer bg-gray-50 px-2 py-1 rounded border border-gray-200">
                            <input type="checkbox" class="form-checkbox text-gray-400"
                                onchange="toggleTrace(1, this.checked)" checked>
                            <span class="text-gray-700">âšª é³ (Stainless)</span>
                        </label>
                        <label
                            class="inline-flex items-center space-x-2 cursor-pointer bg-gray-50 px-2 py-1 rounded border border-gray-200">
                            <input type="checkbox" class="form-checkbox text-gray-600"
                                onchange="toggleTrace(2, this.checked)">
                            <span class="text-gray-500">ğŸ”© é‹¼ç­‹ (éš±è—)</span>
                        </label>
                    </div>
                </div>

                <!-- Group 2: Precious Metals & Forex -->
                <div>
                    <h4 class="text-sm font-bold text-gray-500 mb-2">è²´é‡‘å±¬èˆ‡åŒ¯ç‡ (æ–°å¢)</h4>
                    <div class="flex flex-wrap gap-3">
                        <label
                            class="inline-flex items-center space-x-2 cursor-pointer bg-yellow-50 px-2 py-1 rounded border border-yellow-100">
                            <input type="checkbox" class="form-checkbox text-yellow-500"
                                onchange="toggleTrace(5, this.checked)" checked>
                            <span class="text-gray-700">ğŸ’° é»ƒé‡‘ (Gold)</span>
                        </label>
                        <label
                            class="inline-flex items-center space-x-2 cursor-pointer bg-gray-50 px-2 py-1 rounded border border-gray-200">
                            <input type="checkbox" class="form-checkbox text-gray-500"
                                onchange="toggleTrace(6, this.checked)">
                            <span class="text-gray-700">ğŸ¥ˆ ç™½éŠ€ (Silver)</span>
                        </label>
                        <label
                            class="inline-flex items-center space-x-2 cursor-pointer bg-green-50 px-2 py-1 rounded border border-green-100">
                            <input type="checkbox" class="form-checkbox text-green-600"
                                onchange="toggleTrace(7, this.checked)">
                            <span class="text-gray-700">ğŸ’µ åŒ¯ç‡ (USD/TWD)</span>
                        </label>
                    </div>
                </div>
            </div>

            <hr class="my-3 border-gray-200">

            <!-- Group 3: Stocks -->
            <div>
                <h4 class="text-sm font-bold text-gray-500 mb-2">åœ‹å…§è‚¡åƒ¹</h4>
                <div class="flex flex-wrap gap-4">
                    <label class="inline-flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" class="form-checkbox text-blue-600"
                            onchange="toggleTrace(3, this.checked)" checked>
                        <span class="text-gray-700">ğŸ”µ ä¸­é‹¼ (2002)</span>
                    </label>
                    <label class="inline-flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" class="form-checkbox text-green-600"
                            onchange="toggleTrace(4, this.checked)" checked>
                        <span class="text-gray-700">ğŸŸ¢ è±èˆˆ (2015)</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Main Chart -->
        <div class="chart-container relative">
            <div id="metalChart" style="width:100%; height:900px;"></div>
            <div id="loading" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-75 z-10">
                <span class="text-xl font-bold text-gray-500">è¼‰å…¥æ•¸æ“šä¸­...</span>
            </div>
        </div>

        <!-- External Links -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white p-4 rounded shadow hover:bg-gray-50 transition">
                <h3 class="font-bold text-blue-800">ğŸ“Œ ç›¸é—œé€£çµ</h3>
                <div class="flex flex-col space-y-2 mt-2">
                    <a href="https://tw.stock.yahoo.com/quote/2002.TW" target="_blank"
                        class="text-blue-600 hover:underline">â†— ä¸­é‹¼ (2002) Yahooè‚¡å¸‚</a>
                    <a href="https://tw.stock.yahoo.com/quote/2015.TW" target="_blank"
                        class="text-blue-600 hover:underline">â†— è±èˆˆ (2015) Yahooè‚¡å¸‚</a>
                    <a href="https://finance.yahoo.com/quote/GC=F" target="_blank"
                        class="text-blue-600 hover:underline">â†— é»ƒé‡‘æœŸè²¨</a>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            fetch('metal_data.json')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loading').style.display = 'none';
                    if (data.length > 0) {
                        document.getElementById('lastUpdated').innerText = data[data.length - 1].Date;
                    }
                    renderChart(data);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    document.getElementById('loading').innerText = "è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
                });
        });

        function renderChart(data) {
            const dates = data.map(d => d.Date);

            // Helper to handle 0 or null
            const parseVal = (v) => (v === "" || v === null || v === 0) ? null : parseFloat(v);

            const copper = data.map(d => parseVal(d.Copper_TWD_Kg));
            const rebar = data.map(d => parseVal(d.Steel_Rebar_TWD_Ton));
            const nickel = data.map(d => parseVal(d.Stainless_Index));
            const chinaSteel = data.map(d => parseVal(d.China_Steel_Price));
            const fengHsin = data.map(d => parseVal(d.Feng_Hsin_Price));
            // New
            const gold = data.map(d => parseVal(d.Gold_USD));
            const silver = data.map(d => parseVal(d.Silver_USD));
            const twd = data.map(d => parseVal(d.Exchange_Rate_TWD));

            // Traces
            // 0: Copper
            const traceCopper = {
                x: dates, y: copper, name: 'éŠ…åƒ¹ (TWD/Kg)',
                mode: 'lines', line: { color: '#b87333', width: 2 },
                connectgaps: true, yaxis: 'y1'
            };

            // 1: Nickel
            const traceNickel = {
                x: dates, y: nickel, name: 'é³æŒ‡æ¨™',
                mode: 'lines', line: { color: '#C0C0C0', width: 2 },
                connectgaps: true, yaxis: 'y1'
            };

            // 2: Rebar
            const traceRebar = {
                x: dates, y: rebar, name: 'é‹¼ç­‹ (TWD/å™¸)',
                mode: 'lines', line: { color: '#708090', width: 2, dash: 'dot' },
                connectgaps: true, yaxis: 'y2', visible: 'legendonly'
            };

            // 3: China Steel
            const traceChinaSteel = {
                x: dates, y: chinaSteel, name: 'ä¸­é‹¼è‚¡åƒ¹',
                mode: 'lines', line: { color: '#4682B4', width: 2 },
                connectgaps: true, yaxis: 'y3'
            };

            // 4: Feng Hsin
            const traceFengHsin = {
                x: dates, y: fengHsin, name: 'è±èˆˆè‚¡åƒ¹',
                mode: 'lines', line: { color: '#2E8B57', width: 2 },
                connectgaps: true, yaxis: 'y3'
            };

            // 5: Gold (New) - Use y4 (Right side of top chart)
            const traceGold = {
                x: dates, y: gold, name: 'é»ƒé‡‘ (USD/oz)',
                mode: 'lines', line: { color: '#FFD700', width: 2 },
                connectgaps: true, yaxis: 'y4'
            };

            // 6: Silver (New) - y4
            const traceSilver = {
                x: dates, y: silver, name: 'ç™½éŠ€ (USD/oz)',
                mode: 'lines', line: { color: '#A9A9A9', width: 2 },
                connectgaps: true, yaxis: 'y4', visible: 'legendonly'
            };

            // 7: TWD (New) - y3 (Overlay on stocks?) or y5?
            // Let's put TWD on the Bottom Chart with a secondary axis (right)
            const traceTWD = {
                x: dates, y: twd, name: 'åŒ¯ç‡ (USD/TWD)',
                mode: 'lines', line: { color: '#20B2AA', width: 1, dash: 'dash' },
                connectgaps: true, yaxis: 'y5', visible: 'legendonly'
            };

            // Layout
            const layout = {
                hovermode: 'x unified',
                showlegend: false,
                margin: { t: 50, b: 40, l: 60, r: 60 },

                // TOP CHART (Metals) - Domain 0.55 - 1.0
                yaxis: {
                    title: 'éŠ…åƒ¹ / é³',
                    domain: [0.55, 1], zeroline: false
                },
                // Rebar (Shared with y1 or separate? Rebar is ~17000, Copper 300. Separate)
                yaxis2: {
                    title: 'é‹¼ç­‹', cancel: true, visible: false, overlaying: 'y', side: 'left'
                    // Rebar scaling issue. Let's just put it on Right.
                },
                // Actually, let's designate Right Axis for Precious Metals (Gold ~2000) & Rebar (~17000). 
                // They handle their own ranges if separate axes.
                yaxis4: {
                    title: 'é»ƒé‡‘/ç™½éŠ€ (USD)',
                    overlaying: 'y', side: 'right',
                    titlefont: { color: '#DAA520' }, tickfont: { color: '#DAA520' }
                },

                // BOTTOM CHART (Stocks & Forex) - Domain 0 - 0.45
                yaxis3: {
                    title: 'è‚¡åƒ¹ (TWD)',
                    domain: [0, 0.45], zeroline: false
                },
                yaxis5: {
                    title: 'åŒ¯ç‡',
                    overlaying: 'y3', side: 'right',
                    titlefont: { color: '#20B2AA' }, tickfont: { color: '#20B2AA' }
                },

                xaxis: {
                    anchor: 'y3',
                    rangeselector: {
                        buttons: [
                            { count: 1, label: '1M', step: 'month', stepmode: 'backward' },
                            { count: 3, label: '3M', step: 'month', stepmode: 'backward' },
                            { count: 6, label: '6M', step: 'month', stepmode: 'backward' },
                            { count: 1, label: '1Y', step: 'year', stepmode: 'backward' },
                            { step: 'all', label: 'All' }
                        ]
                    },
                    type: 'date'
                }
            };

            // Adjust Rebar to use y4? No, 17000 vs 2000. 
            // Rebar needs its own or hidden. If visible, it might squash others if sharing axis.
            // Let's force Rebar to y2 which overlays y1 (Left) but invisible axis line to avoid clutter?
            layout.yaxis2 = { overlaying: 'y', side: 'right', position: 0.95, showgrid: false, title: 'é‹¼ç­‹' };

            const traces = [traceCopper, traceNickel, traceRebar, traceChinaSteel, traceFengHsin, traceGold, traceSilver, traceTWD];

            Plotly.newPlot('metalChart', traces, layout);
        }

        function toggleTrace(index, isChecked) {
            Plotly.restyle('metalChart', { 'visible': isChecked ? true : 'legendonly' }, [index]);
        }
    </script>
</body>

</html>