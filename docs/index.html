<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‘å±¬è¡Œæƒ…äº’å‹•å„€è¡¨æ¿</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background-color: #f3f4f6;
        }

        .chart-box {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
    </style>
</head>

<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded shadow">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">ğŸ“Š ç¶œåˆåŸç‰©æ–™è¡Œæƒ…å„€è¡¨æ¿</h1>
                <p class="text-gray-600 mt-2">åœ‹éš›é‡‘å±¬ vs åœ‹å…§è‚¡åƒ¹</p>
            </div>
            <div class="mt-4 md:mt-0 text-right">
                <span class="text-sm text-gray-500">æœ€å¾Œæ›´æ–°: <span id="lastUpdated">-</span></span>
            </div>
        </header>

        <!-- Macro Chart Section -->
        <div class="chart-box">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-700">ğŸŒ åœ‹éš›é‡‘å±¬èˆ‡åŒ¯ç‡</h3>
                <div id="controlsMacro" class="flex flex-wrap gap-4 text-sm"></div>
            </div>
            <div id="macroChart" style="width:100%; height:450px;"></div>
        </div>

        <!-- Stock Chart Section -->
        <div class="chart-box">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-700">ğŸ‡¹ğŸ‡¼ åœ‹å…§é‹¼éµè‚¡åƒ¹ & é‹¼ç­‹</h3>
                <div id="controlsStock" class="flex flex-wrap gap-4 text-sm"></div>
            </div>
            <div id="stockChart" style="width:100%; height:450px;"></div>
        </div>

        <!-- Web Ops Section -->
        <div class="bg-blue-50 p-6 rounded shadow border border-blue-100 text-center">
            <h3 class="font-bold text-gray-800 mb-2">ğŸ“¢ è‚¡ç¥¨ç®¡ç† (Web Ops)</h3>
            <p class="text-gray-600 text-sm mb-4">æ‚¨å¯ä»¥ç›´æ¥é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œé€é GitHub Issue ä¾†æ–°å¢æˆ–åˆªé™¤è‚¡ç¥¨ï¼Œæ©Ÿå™¨äººæœƒè‡ªå‹•è™•ç†ï¼</p>

            <div class="flex justify-center gap-4">
                <a href="https://github.com/haowen325/PC-Price-Tracker/issues/new?title=Add%20Stock:%202002.TW%20%E4%B8%AD%E9%92%BC&body=%E8%AB%8B%E6%9B%BF%E6%8F%9B%E6%A8%99%E9%A1%8C%E4%B8%AD%E7%9A%84%E4%BB%A3%E8%99%9F%E8%88%87%E5%90%8D%E7%A8%B1%E3%80%82%0AExample:%20Add%20Stock:%202330.TW%20%E5%8F%B0%E7%A9%8D%E9%9B%BB"
                    target="_blank"
                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow flex items-center">
                    â• æ–°å¢è‚¡ç¥¨ (Add Stock)
                </a>

                <a href="https://github.com/haowen325/PC-Price-Tracker/issues/new?title=Add%20Stock:%202330.TW%20%E5%8F%B0%E7%A9%8D%E9%9B%BB&body=%E8%AB%8B%E6%9B%BF%E6%8F%9B%E6%A8%99%E9%A1%8C%E4%B8%AD%E7%9A%84%E4%BB%A3%E8%99%9F%E8%88%87%E5%90%8D%E7%A8%B1%E3%80%82%0AExample:%20Add%20Stock:%202330.TW%20%E5%8F%B0%E7%A9%8D%E9%9B%BB"
                    target="_blank"
                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow flex items-center">
                    â• æ–°å¢è‚¡ç¥¨ (Add Stock)
                </a>
            </div>

            <div class="mt-6 border-t pt-4">
                <p class="text-sm text-gray-700 font-bold mb-2">å·²è¿½è¹¤è‚¡ç¥¨ (é»æ“Šåˆªé™¤):</p>
                <div id="removeStockList" class="flex flex-wrap justify-center gap-2">
                    <!-- Dynamic buttons will appear here -->
                    <span class="text-gray-400 text-sm">è¼‰å…¥ä¸­...</span>
                </div>
            </div>
            <p class="text-xs text-gray-400 mt-2">æç¤º: é€å‡º Issue å¾Œè«‹ç­‰å¾…ç´„ 1-2 åˆ†é˜ï¼Œç¶²é æ›´æ–°éœ€è¦ä¸€é»æ™‚é–“ã€‚</p>
        </div>
    </div>

    <script>
        let rawData = [];
        let config = {};

        // Configuration for static traces
        const macroTraces = [
            { key: 'Copper_TWD_Kg', name: 'ğŸ”¶ éŠ…åƒ¹ (TWD)', color: '#b87333', axis: 'y1', checked: true },
            { key: 'Stainless_Index', name: 'âšª é³æŒ‡æ¨™', color: '#C0C0C0', axis: 'y1', checked: true },
            { key: 'Gold_USD', name: 'ğŸ’° é»ƒé‡‘ (USD)', color: '#FFD700', axis: 'y2', checked: true },
            { key: 'Silver_USD', name: 'ğŸ¥ˆ ç™½éŠ€ (USD)', color: '#A9A9A9', axis: 'y2', checked: false },
            { key: 'Exchange_Rate_TWD', name: 'ğŸ’µ åŒ¯ç‡', color: '#20B2AA', axis: 'y2', checked: true }
        ];

        const stockStaticTraces = [
            // Rebar goes to Y2 (Right Axis) because it's ~17000 vs Stocks ~50
            { key: 'Steel_Rebar_TWD_Ton', name: 'ğŸ”© é‹¼ç­‹ (TWD/å™¸)', color: '#708090', axis: 'y2', checked: true }
        ];

        let stockDynamicTraces = [];

        document.addEventListener("DOMContentLoaded", async function () {
            try {
                // Load Config & Data
                const [cfgRes, dataRes] = await Promise.all([
                    fetch('metal_config.json').then(r => r.ok ? r.json() : {}),
                    fetch('metal_data.json').then(r => r.json())
                ]);
                config = cfgRes;
                rawData = dataRes;

                if (rawData.length > 0) {
                    document.getElementById('lastUpdated').innerText = rawData[rawData.length - 1].Date;
                }

                // Prepare Traces
                prepareStockTraces();

                // Render
                renderChart('macroChart', macroTraces, 'controlsMacro', 'åƒ¹æ ¼', 'è²´é‡‘å±¬/åŒ¯ç‡');
                renderChart('stockChart', [...stockDynamicTraces, ...stockStaticTraces], 'controlsStock', 'è‚¡åƒ¹ (TWD)', 'é‹¼ç­‹ (TWD/å™¸)');

                renderWebOps(); // New function call

            } catch (e) {
                console.error("Init failed", e);
            }
        });

        function renderWebOps() {
            const container = document.getElementById('removeStockList');
            if (!container) return;
            container.innerHTML = '';

            // Get current dynamic stocks
            const currentStocks = Object.keys(config.stocks || {});

            if (currentStocks.length === 0) {
                container.innerHTML = '<span class="text-gray-400 text-sm">ç›®å‰æ²’æœ‰è¿½è¹¤çš„å€‹è‚¡ï¼Œè«‹æ–°å¢ã€‚</span>';
                return;
            }

            currentStocks.forEach(code => {
                const name = config.stocks[code];
                const btn = document.createElement('a');
                // Pre-fill Title: Remove Stock: CODE
                const issueTitle = encodeURIComponent(`Remove Stock: ${code}`);
                const issueBody = encodeURIComponent(`é»æ“Š "Submit new issue" (ç¶ è‰²æŒ‰éˆ•) ä»¥ç¢ºèªåˆªé™¤ ${name} (${code})ã€‚`);

                btn.href = `https://github.com/haowen325/PC-Price-Tracker/issues/new?title=${issueTitle}&body=${issueBody}`;
                btn.target = "_blank";
                btn.className = "inline-flex items-center px-3 py-1 border border-red-200 shadow-sm text-sm leading-4 font-medium rounded-md text-red-700 bg-red-50 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 m-1 no-underline";
                btn.style.textDecoration = 'none';
                btn.innerHTML = `ğŸ—‘ï¸ åˆªé™¤ ${name}`;

                container.appendChild(btn);
            });
        }

        function prepareStockTraces() {
            if (rawData.length === 0) return;
            const sample = rawData[rawData.length - 1];
            const stockKeys = Object.keys(sample).filter(k => k.startsWith('Stock_'));

            stockDynamicTraces = stockKeys.map((k, idx) => {
                const code = k.replace('Stock_', '');
                let name = code;
                if (config.stocks && config.stocks[code]) {
                    name = config.stocks[code] + ` (${code})`;
                }
                const colors = ['#4682B4', '#2E8B57', '#DC143C', '#8A2BE2', '#FF4500'];
                return {
                    key: k,
                    name: `ğŸ“ˆ ${name}`,
                    color: colors[idx % colors.length],
                    axis: 'y1', // Stocks on Left Axis
                    checked: true
                };
            });
        }

        function renderChart(divId, tracesDef, controlsId, leftTitle, rightTitle) {
            const dates = rawData.map(d => d.Date);
            const container = document.getElementById(controlsId);
            container.innerHTML = '';

            // Generate Controls
            tracesDef.forEach((t, i) => {
                const span = document.createElement('label');
                span.className = "flex items-center cursor-pointer space-x-1";
                span.innerHTML = `
                    <input type="checkbox" class="form-checkbox text-blue-600 h-4 w-4" 
                        ${t.checked ? 'checked' : ''}>
                    <span style="color:${t.color}; font-weight:bold;">${t.name}</span>
                `;
                span.querySelector('input').onchange = (e) => {
                    Plotly.restyle(divId, { visible: e.target.checked ? true : 'legendonly' }, [i]);
                };
                container.appendChild(span);
            });

            // Make Plotly Traces
            const plotData = tracesDef.map(t => ({
                x: dates,
                y: rawData.map(d => (d[t.key] === null || d[t.key] === "") ? null : d[t.key]),
                name: t.name,
                type: 'scatter',
                mode: 'lines',
                line: { color: t.color, width: 2 },
                connectgaps: true,
                yaxis: t.axis,
                visible: t.checked ? true : 'legendonly'
            }));

            const layout = {
                margin: { t: 20, b: 40, l: 50, r: 50 },
                hovermode: 'x unified',
                showlegend: false,
                yaxis: { title: leftTitle, zeroline: false },
                yaxis2: {
                    title: rightTitle,
                    overlaying: 'y',
                    side: 'right',
                    titlefont: { color: '#555' },
                    tickfont: { color: '#555' },
                    zeroline: false
                },
                xaxis: {
                    rangeselector: {
                        buttons: [
                            { count: 1, label: '1M', step: 'month', stepmode: 'backward' },
                            { count: 3, label: '3M', step: 'month', stepmode: 'backward' },
                            { count: 1, label: '1Y', step: 'year', stepmode: 'backward' },
                            { step: 'all', label: 'All' }
                        ]
                    },
                    type: 'date'
                }
            };

            Plotly.newPlot(divId, plotData, layout, { responsive: true });
        }
    </script>
</body>

</html>