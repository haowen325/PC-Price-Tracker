<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‘å±¬è¡Œæƒ…äº’å‹•å„€è¡¨æ¿ (Dynamic)</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background-color: #f3f4f6;
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 2rem;
        }
    </style>
</head>

<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded shadow">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">ğŸ“Š ç¶œåˆåŸç‰©æ–™è¡Œæƒ…å„€è¡¨æ¿</h1>
                <p class="text-gray-600 mt-2">è‡ªå®šç¾©åœ–è¡¨é…ç½®èˆ‡å‹•æ…‹è¿½è¹¤</p>
            </div>
            <div class="mt-4 md:mt-0 text-right">
                <span class="text-sm text-gray-500">æœ€å¾Œæ›´æ–°: <span id="lastUpdated">-</span></span>
            </div>
        </header>

        <!-- Controls -->
        <div class="bg-white p-4 rounded shadow mb-6">
            <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">åœ–è¡¨é…ç½® (å‹¾é¸é¡¯ç¤º / é¸æ“‡è»¸å‘)</h3>
            <div id="controlsArea" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Javascript will populate this -->
            </div>
            <div class="mt-4 text-xs text-gray-500 text-right">
                * è»¸å‘èªªæ˜: ä¸Šåœ–(Metal/Macro), ä¸‹åœ–(Stock). å»ºè­°å°‡æ•¸å€¼ç›¸è¿‘çš„é …ç›®æ”¾åœ¨åŒä¸€è»¸ã€‚
            </div>
        </div>

        <!-- Main Chart -->
        <div class="chart-container relative">
            <div id="metalChart" style="width:100%; height:900px;"></div>
            <div id="loading" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-75 z-10">
                <span class="text-xl font-bold text-gray-500">è¼‰å…¥æ•¸æ“šä¸­...</span>
            </div>
        </div>

        <div class="bg-gray-100 p-4 rounded text-center text-gray-600 text-sm mt-8 border border-gray-200">
            <p>ğŸ’¡ <b>å¦‚ä½•æ–°å¢è‚¡ç¥¨ï¼Ÿ</b></p>
            <p class="mt-1">ç”±æ–¼æ­¤ç‚ºéœæ…‹ç¶²é ï¼Œè«‹åœ¨é›»è…¦ä¸ŠåŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ä¾†é–‹å•Ÿç®¡ç†å·¥å…·ï¼š</p>
            <code
                class="bg-gray-800 text-white px-2 py-1 rounded mt-2 inline-block">python tools/stock_manager.py</code>
            <p class="mt-2 text-xs text-gray-400">æ–°å¢å¾Œï¼Œç³»çµ±å°‡æ–¼ä¸‹æ¬¡è‡ªå‹•æ›´æ–°æ™‚æŠ“å–åƒ¹æ ¼ã€‚</p>
        </div>
    </div>

    <script>
        // Global State
        let rawData = [];
        let config = {};
        let tracesConfig = []; // { id, name, color, defaultAxis }

        // Axes Configuration
        const AXIS_OPTS = [
            { val: 'y1', label: 'ä¸Šåœ–-å·¦è»¸ (åƒ¹æ ¼)' },
            { val: 'y2', label: 'ä¸Šåœ–-å³è»¸ (é«˜åƒ¹)' },
            { val: 'y3', label: 'ä¸‹åœ–-å·¦è»¸ (è‚¡åƒ¹)' },
            { val: 'y4', label: 'ä¸‹åœ–-å³è»¸ (åŒ¯ç‡)' }
        ];

        document.addEventListener("DOMContentLoaded", async function () {
            try {
                // 1. Load Config
                const cfgRes = await fetch('metal_config.json');
                if (cfgRes.ok) config = await cfgRes.json();
                else console.warn("Config not found, using defaults");

                // 2. Load Data
                const dataRes = await fetch('metal_data.json');
                rawData = await dataRes.json();

                if (rawData.length > 0) {
                    document.getElementById('lastUpdated').innerText = rawData[rawData.length - 1].Date;
                }

                // 3. Keep legacy logic + Dynamic logic
                initTraces();
                renderControls();
                renderChart();
                document.getElementById('loading').style.display = 'none';

            } catch (error) {
                console.error('Init failed:', error);
                document.getElementById('loading').innerText = "è¼‰å…¥å¤±æ•—";
            }
        });

        function initTraces() {
            // Define all available metrics
            // Format: ID (json key), Name, Color, DefaultAxis

            tracesConfig = [
                { key: 'Copper_TWD_Kg', name: 'ğŸ”¶ éŠ…åƒ¹ (TWD)', color: '#b87333', axis: 'y1', checked: true },
                { key: 'Stainless_Index', name: 'âšª é³æŒ‡æ¨™', color: '#C0C0C0', axis: 'y1', checked: true },
                { key: 'Steel_Rebar_TWD_Ton', name: 'ğŸ”© é‹¼ç­‹', color: '#708090', axis: 'y2', checked: false }, // Use Right Axis for high value
                { key: 'Gold_USD', name: 'ğŸ’° é»ƒé‡‘ (USD)', color: '#FFD700', axis: 'y2', checked: true },
                { key: 'Silver_USD', name: 'ğŸ¥ˆ ç™½éŠ€ (USD)', color: '#A9A9A9', axis: 'y2', checked: false },
                { key: 'Exchange_Rate_TWD', name: 'ğŸ’µ åŒ¯ç‡ (USD/TWD)', color: '#20B2AA', axis: 'y4', checked: true }
            ];

            // Dynamic Stocks from Config or Data
            // If data has "Stock_XXXX", add it.
            if (rawData.length > 0) {
                const sample = rawData[rawData.length - 1];
                const stockKeys = Object.keys(sample).filter(k => k.startsWith('Stock_'));

                stockKeys.forEach((k, idx) => {
                    const code = k.replace('Stock_', '');
                    // Try to get name from config
                    let name = code;
                    if (config.stocks && config.stocks[code]) {
                        name = config.stocks[code] + ` (${code})`;
                    }

                    // Assign colors dynamically or cycle
                    const colors = ['#4682B4', '#2E8B57', '#DC143C', '#8A2BE2', '#FF4500'];
                    const color = colors[idx % colors.length];

                    tracesConfig.push({
                        key: k,
                        name: `ğŸ“ˆ ${name}`,
                        color: color,
                        axis: 'y3', // Default to Bottom Left
                        checked: true
                    });
                });
            }
        }

        function renderControls() {
            const container = document.getElementById('controlsArea');
            container.innerHTML = '';

            tracesConfig.forEach((trace, index) => {
                const div = document.createElement('div');
                div.className = "flex flex-col bg-gray-50 p-3 rounded border border-gray-200";

                // Header (Checkbox + Name)
                const header = document.createElement('label');
                header.className = "flex items-center space-x-2 cursor-pointer mb-2 font-bold";
                header.innerHTML = `
                    <input type="checkbox" class="form-checkbox h-5 w-5" 
                        style="color:${trace.color}" 
                        ${trace.checked ? 'checked' : ''}
                        onchange="updateTraceVisibility(${index}, this.checked)">
                    <span style="color:${trace.color}">${trace.name}</span>
                `;
                div.appendChild(header);

                // Axis Selector
                const select = document.createElement('select');
                select.className = "text-sm border-gray-300 rounded shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50";
                select.onchange = (e) => updateTraceAxis(index, e.target.value);

                AXIS_OPTS.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.val;
                    option.text = opt.label;
                    if (opt.val === trace.axis) option.selected = true;
                    select.appendChild(option);
                });

                div.appendChild(select);
                container.appendChild(div);
            });
        }

        function renderChart() {
            const dates = rawData.map(d => d.Date);

            const traces = tracesConfig.map(tc => {
                return {
                    x: dates,
                    y: rawData.map(d => (d[tc.key] === "" || d[tc.key] === null || d[tc.key] === 0) ? null : parseFloat(d[tc.key])),
                    name: tc.name,
                    mode: 'lines',
                    line: { color: tc.color, width: 2 },
                    connectgaps: true,
                    yaxis: tc.axis,
                    visible: tc.checked ? true : 'legendonly'
                };
            });

            const layout = {
                hovermode: 'x unified',
                showlegend: false, // Custom controls replace legend
                margin: { t: 50, b: 40, l: 60, r: 60 },
                height: 900,

                // TOP CHART (Domain 0.55 - 1.0)
                yaxis: {
                    title: 'ä¸Šåœ–-å·¦è»¸',
                    domain: [0.55, 1], zeroline: false
                },
                yaxis2: {
                    title: 'ä¸Šåœ–-å³è»¸',
                    overlaying: 'y', side: 'right',
                    titlefont: { color: '#555' }, tickfont: { color: '#555' }
                },

                // BOTTOM CHART (Domain 0 - 0.45)
                yaxis3: {
                    title: 'ä¸‹åœ–-å·¦è»¸',
                    domain: [0, 0.45], zeroline: false
                },
                yaxis4: {
                    title: 'ä¸‹åœ–-å³è»¸',
                    overlaying: 'y3', side: 'right',
                    titlefont: { color: '#555' }, tickfont: { color: '#555' }
                },

                xaxis: {
                    anchor: 'y3', // Anchor to bottom chart
                    rangeselector: {
                        buttons: [
                            { count: 1, label: '1M', step: 'month', stepmode: 'backward' },
                            { count: 3, label: '3M', step: 'month', stepmode: 'backward' },
                            { count: 6, label: '6M', step: 'month', stepmode: 'backward' },
                            { count: 1, label: '1Y', step: 'year', stepmode: 'backward' },
                            { step: 'all', label: 'All' }
                        ]
                    },
                    type: 'date'
                }
            };

            Plotly.newPlot('metalChart', traces, layout);
        }

        function updateTraceVisibility(index, isChecked) {
            tracesConfig[index].checked = isChecked;
            Plotly.restyle('metalChart', { visible: isChecked ? true : 'legendonly' }, [index]);
        }

        function updateTraceAxis(index, newAxis) {
            tracesConfig[index].axis = newAxis;
            // Full redraw is safer for Axis changes in subplots
            renderChart();
        }
    </script>
</body>

</html>