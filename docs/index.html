<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‘å±¬è¡Œæƒ…äº’å‹•å„€è¡¨æ¿</title>
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background-color: #f3f4f6;
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 2rem;
        }
    </style>
</head>

<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded shadow">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">ğŸ“Š é‡‘å±¬åŸç‰©æ–™è¡Œæƒ…å„€è¡¨æ¿</h1>
                <p class="text-gray-600 mt-2">å³æ™‚è¿½è¹¤éŠ…åƒ¹ã€é‹¼ç­‹ã€é³åŠç›¸é—œè‚¡åƒ¹è¶¨å‹¢ã€‚</p>
            </div>
            <div class="mt-4 md:mt-0 text-right">
                <span class="text-sm text-gray-500">æœ€å¾Œæ›´æ–°: <span id="lastUpdated">-</span></span>
            </div>
        </header>

        <!-- Controls -->
        <div class="bg-white p-4 rounded shadow mb-6">
            <h3 class="font-bold text-gray-700 mb-2">é¡¯ç¤ºè¨­å®š (å‹¾é¸ä»¥é¡¯ç¤º/éš±è—)</h3>
            <div class="flex flex-wrap gap-4">
                <label class="inline-flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" class="form-checkbox h-5 w-5 text-orange-600"
                        onchange="toggleTrace(0, this.checked)" checked>
                    <span class="text-gray-700 font-medium">ğŸ”¶ éŠ…åƒ¹ (Copper)</span>
                </label>
                <label class="inline-flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" class="form-checkbox h-5 w-5 text-gray-400"
                        onchange="toggleTrace(1, this.checked)" checked>
                    <span class="text-gray-700 font-medium">âšª é³æŒ‡æ¨™ (Nickel)</span>
                </label>
                <label class="inline-flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" class="form-checkbox h-5 w-5 text-gray-600"
                        onchange="toggleTrace(2, this.checked)">
                    <span class="text-gray-700 font-medium">ğŸ”© é‹¼ç­‹ (Rebar) (é è¨­éš±è—)</span>
                </label>
            </div>
            <hr class="my-3 border-gray-200">
            <div class="flex flex-wrap gap-4">
                <label class="inline-flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-600"
                        onchange="toggleTrace(3, this.checked)" checked>
                    <span class="text-gray-700 font-medium">ğŸ”µ ä¸­é‹¼è‚¡åƒ¹ (2002)</span>
                </label>
                <label class="inline-flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" class="form-checkbox h-5 w-5 text-green-600"
                        onchange="toggleTrace(4, this.checked)" checked>
                    <span class="text-gray-700 font-medium">ğŸŸ¢ è±èˆˆè‚¡åƒ¹ (2015)</span>
                </label>
            </div>
        </div>

        <!-- Main Chart -->
        <div class="chart-container relative">
            <div id="metalChart" style="width:100%; height:800px;"></div>
            <div id="loading" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-75 z-10">
                <span class="text-xl font-bold text-gray-500">è¼‰å…¥æ•¸æ“šä¸­...</span>
            </div>
        </div>

        <!-- External Links -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white p-4 rounded shadow hover:bg-gray-50 transition">
                <h3 class="font-bold text-blue-800">ğŸ“Œ ç›¸é—œé€£çµ</h3>
                <div class="flex flex-col space-y-2 mt-2">
                    <a href="https://tw.stock.yahoo.com/quote/2002.TW" target="_blank"
                        class="text-blue-600 hover:underline">â†— ä¸­é‹¼ (2002) Yahooè‚¡å¸‚</a>
                    <a href="https://tw.stock.yahoo.com/quote/2015.TW" target="_blank"
                        class="text-blue-600 hover:underline">â†— è±èˆˆ (2015) Yahooè‚¡å¸‚</a>
                    <a href="https://finance.yahoo.com/quote/HG=F" target="_blank"
                        class="text-blue-600 hover:underline">â†— LME éŠ…æœŸè²¨è¡Œæƒ…</a>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            fetch('metal_data.json')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loading').style.display = 'none';
                    if (data.length > 0) {
                        document.getElementById('lastUpdated').innerText = data[data.length - 1].Date;
                    }
                    renderChart(data);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    document.getElementById('loading').innerText = "è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
                });
        });

        function renderChart(data) {
            // Process Data
            const dates = data.map(d => d.Date);
            const copper = data.map(d => parseFloat(d.Copper_TWD_Kg));
            const rebar = data.map(d => parseFloat(d.Steel_Rebar_TWD_Ton));

            // Handle optional columns
            const nickel = data.map(d => d.Stainless_Index ? parseFloat(d.Stainless_Index) : null);
            const chinaSteel = data.map(d => d.China_Steel_Price ? parseFloat(d.China_Steel_Price) : null);
            const fengHsin = data.map(d => d.Feng_Hsin_Price ? parseFloat(d.Feng_Hsin_Price) : null);

            // Traces
            // Index 0
            const traceCopper = {
                x: dates, y: copper, name: 'éŠ…åƒ¹ (TWD/Kg)',
                mode: 'lines', line: { color: '#b87333', width: 2 },
                yaxis: 'y1', xaxis: 'x'
            };

            // Index 1
            const traceNickel = {
                x: dates, y: nickel, name: 'é³æŒ‡æ¨™',
                mode: 'lines', line: { color: '#C0C0C0', width: 2 },
                yaxis: 'y1', xaxis: 'x'
            };

            // Index 2
            const traceRebar = {
                x: dates, y: rebar, name: 'é‹¼ç­‹ (TWD/å™¸)',
                mode: 'lines', line: { color: '#708090', width: 2, dash: 'dot' },
                yaxis: 'y2', xaxis: 'x',
                visible: 'legendonly' // matches default checkbox state (unchecked in HTML logic handling needed)
            };

            // Index 3
            const traceChinaSteel = {
                x: dates, y: chinaSteel, name: 'ä¸­é‹¼è‚¡åƒ¹',
                mode: 'lines', line: { color: '#4682B4', width: 2 },
                yaxis: 'y3', xaxis: 'x'
            };

            // Index 4
            const traceFengHsin = {
                x: dates, y: fengHsin, name: 'è±èˆˆè‚¡åƒ¹',
                mode: 'lines', line: { color: '#2E8B57', width: 2 },
                yaxis: 'y3', xaxis: 'x'
            };

            // Define Layout with Gap
            const layout = {
                hovermode: 'x unified',
                showlegend: false, // Hiding default legend to use our custom controls

                // Top Chart: Metal Prices
                // Domain: 0.6 to 1.0 (40% height)
                yaxis: {
                    title: 'éŠ…åƒ¹ / é³æŒ‡æ•¸',
                    domain: [0.6, 1],
                    zeroline: false
                },
                yaxis2: {
                    title: 'é‹¼ç­‹åƒ¹æ ¼',
                    overlaying: 'y',
                    side: 'right',
                    titlefont: { color: '#708090' },
                    tickfont: { color: '#708090' }
                },

                // Bottom Chart: Stock Prices
                // Domain: 0 to 0.4 (40% height) -> 0.2 gap
                yaxis3: {
                    title: 'è‚¡åƒ¹ (TWD)',
                    domain: [0, 0.45],
                    zeroline: false
                },

                xaxis: {
                    anchor: 'y3', // Axis at bottom
                    rangeselector: {
                        buttons: [
                            { count: 1, label: '1æœˆ', step: 'month', stepmode: 'backward' },
                            { count: 3, label: '3æœˆ', step: 'month', stepmode: 'backward' },
                            { count: 6, label: '6æœˆ', step: 'month', stepmode: 'backward' },
                            { step: 'all', label: 'å…¨éƒ¨' }
                        ]
                    },
                    type: 'date'
                },

                margin: { t: 40, b: 40, l: 60, r: 60 }
            };

            const traces = [traceCopper, traceNickel, traceRebar, traceChinaSteel, traceFengHsin];

            loadingDiv = document.getElementById('loading');
            Plotly.newPlot('metalChart', traces, layout);
        }

        function toggleTrace(index, isChecked) {
            Plotly.restyle('metalChart', { 'visible': isChecked ? true : 'legendonly' }, [index]);
        }
    </script>
</body>

</html>